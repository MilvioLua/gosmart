$<?php
error_reporting( E_ERROR );
header( 'Content-Type: text/html; charset=utf-8' );
require_once( str_replace( array( "\\", "/" ), array( MSDIRS, MSDIRS ), dirname( __FILE__ ) ) . MSDIRS . ".." . MSDIRS . "lib" . MSDIRS . "PHPExcel.php" );
$path = str_replace( array( "\\", "/" ), array( MSDIRS, MSDIRS ), dirname( __FILE__ ) ) . MSDIRS . ".." . MSDIRS . "exports" . MSDIRS . $survey_exp[ 'id' ] . ".xls";
$cacheMethod = PHPExcel_CachedObjectStorageFactory:: cache_to_phpTemp;
$cacheSettings = array( ' memoryCacheSize ' => '16MB');
PHPExcel_Settings::setCacheStorageMethod($cacheMethod, $cacheSettings);
$objPHPExcelWriter = new PHPExcel();

// Set document properties
$objPHPExcelWriter->getProperties()->setCreator("Modal Survey")
							 ->setLastModifiedBy("Modal Survey")
							 ->setTitle($survey_exp['name'])
							 ->setSubject($survey_exp['name'])
							 ->setDescription($survey_exp['name']." " . esc_html__( 'generated by', MODAL_SURVEY_TEXT_DOMAIN ) . " Modal Survey");

$csvheader_row = array(
    'font'  => array(
        'bold'  => true,
        'color' => array('rgb' => '000000'),
        'size'  => 10,
        'name'  => 'Helvetica'
    ));
$csvheader_normal_row = array(
    'font'  => array(
        'bold'  => false,
        'color' => array('rgb' => '000000'),
        'size'  => 10,
        'name'  => 'Helvetica'
    ));

			$c=1;
			$objPHPExcelWriter->getActiveSheet()->getColumnDimension('A')->setWidth(60);
			$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Survey ID', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, $survey_exp['id'])->getStyle('A'.$c)->applyFromArray($csvheader_row);
			$c++;
			$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Survey Name', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, $survey_exp['name'])->getStyle('A'.$c)->applyFromArray($csvheader_row);
			$c++;
			$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Generated', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, str_replace("'", "", $survey_exp['export_time']))->getStyle('A'.$c)->applyFromArray($csvheader_row);
			$c++;
			$objPHPExcelWriter->getActiveSheet()->getStyle('A'.$c.':B'.$c)->getAlignment()->setWrapText(true)->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
			if ( $personal ) {
				$c++;
				$objPHPExcelWriter->getActiveSheet()->getColumnDimension('A')->setWidth(60);
				$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'User ID', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, $survey_exp[ 'user_details' ]->autoid )->getStyle('A'.$c)->applyFromArray($csvheader_row);
				$c++;
				$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Username', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, ( $survey_exp[ 'user_details' ]->username ? $survey_exp[ 'user_details' ]->username : esc_html__( 'Not Specified', MODAL_SURVEY_TEXT_DOMAIN ) ))->getStyle('A'.$c)->applyFromArray($csvheader_row);
				$c++;
				$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Created', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, $survey_exp[ 'user_details' ]->created)->getStyle('A'.$c)->applyFromArray($csvheader_row);
				$objPHPExcelWriter->getActiveSheet()->getStyle('A'.$c.':B'.$c)->getAlignment()->setWrapText(true)->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
				$c++;
				$objPHPExcelWriter->getActiveSheet()->getColumnDimension('A')->setWidth(60);
				$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Email', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, $survey_exp[ 'user_details' ]->email)->getStyle('A'.$c)->applyFromArray($csvheader_row);
				$c++;
				$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Name', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, $survey_exp[ 'user_details' ]->name)->getStyle('A'.$c)->applyFromArray($csvheader_row);
				$objPHPExcelWriter->getActiveSheet()->getStyle('A'.$c.':B'.$c)->getAlignment()->setWrapText(true)->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
				$c++;
				if ( ! empty( $survey_exp[ 'user_details' ]->custom ) ) {
					foreach ( unserialize( $survey_exp[ 'user_details' ]->custom ) as $muc_index=>$muc ) {
						$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, ucfirst( strtolower( $muc_index ) ))->setCellValue('B'.$c, $muc)->getStyle('A'.$c)->applyFromArray($csvheader_row);
						$objPHPExcelWriter->getActiveSheet()->getStyle('A'.$c.':B'.$c)->getAlignment()->setWrapText(true)->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
						$c++;
					}
				}
				$objPHPExcelWriter->getActiveSheet()->getColumnDimension('A')->setWidth(60);
				$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Total Score', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, $survey_exp[ 'user_details' ]->allscore)->getStyle('A'.$c)->applyFromArray($csvheader_row);
				$c++;
				$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Required Time', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, $survey_exp[ 'user_details' ]->alltimer . esc_html__( 'sec', MODAL_SURVEY_TEXT_DOMAIN ))->getStyle('A'.$c)->applyFromArray($csvheader_row);
				$objPHPExcelWriter->getActiveSheet()->getStyle('A'.$c.':B'.$c)->getAlignment()->setWrapText(true)->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
				$c++;
					$objPHPExcelWriter->setActiveSheetIndex(0)
					->setCellValue('A'.$c, esc_html__( 'Participant answers marked with stars: *', MODAL_SURVEY_TEXT_DOMAIN ) )->getStyle('A'.$c.':C'.$c)->applyFromArray($csvheader_normal_row);;
			}
			$c++;
			$c++;
			$objPHPExcelWriter->getActiveSheet()->getColumnDimension('A')->setWidth(60);
			if ( $personal ) {
				$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Question / Answer', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, esc_html__( 'Score', MODAL_SURVEY_TEXT_DOMAIN ))->getStyle('A'.$c.':B'.$c)->applyFromArray($csvheader_row);
			}
			else {
				$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Question / Answer', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, esc_html__( 'Votes', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('C'.$c, esc_html__( 'Percentage', MODAL_SURVEY_TEXT_DOMAIN ))->getStyle('A'.$c.':C'.$c)->applyFromArray($csvheader_row);		
			}
			$c++;
			$totalscore = 0;
			foreach( $survey_exp[ 'questions' ] as $qkey=>$questions ) {
				$objPHPExcelWriter->setActiveSheetIndex(0)
				->setCellValue('A'.$c, $questions['name'])->getStyle('A'.$c)->applyFromArray($csvheader_normal_row);
				$objPHPExcelWriter->getActiveSheet()->getStyle('A'.$c)->getAlignment()->setWrapText(true)->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
				$c++;
				foreach ($questions as $key=>$answer) {
					if ( is_numeric( $key ) ) {
						$marker = "";
						$admin_comment = "";
						if ( $personal ) {
							$aoptions = unserialize( $answer[ 'aoptions' ] );
							if ( in_array( $key, $user_votes[ $qkey ] ) ) {
								$marker = "* ";
								$admin_comment = $aoptions[ 16 ];
							}
							if ( $aoptions[ 4 ] != "" && in_array( $key, $user_votes[ $qkey ] ) ) {
								$score = $aoptions[ 4 ];
								$totalscore += $score;
							}
							else {
								$score = "";
							}
							if ( $aoptions[ 0 ] == "open" || $aoptions[ 0 ] == "date" || $aoptions[ 0 ] == "select" || $aoptions[ 0 ] == "numeric" ) {
								$opan = explode( "|", $user_votes[ $qkey ][ $key ] );
								if ( isset( $opan[ 1 ] ) ) {
									$answer[ 'answer' ] = esc_html__( 'Other', MODAL_SURVEY_TEXT_DOMAIN ) . ": " . $opan[ 1 ];
								}
							}
							$objPHPExcelWriter->setActiveSheetIndex(0)
							->setCellValue('A'.$c, $marker . $answer['answer'])->setCellValue('D'.$c, $score)->setCellValue('E'.$c, $admin_comment)->getStyle('A'.$c)->applyFromArray($csvheader_normal_row);
							$objPHPExcelWriter->getActiveSheet()->getStyle('A'.$c.':E'.$c)->getAlignment()->setWrapText(true)->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
						}
						else {
							$objPHPExcelWriter->setActiveSheetIndex(0)
							->setCellValue('A'.$c, $marker . $answer['answer'])->setCellValue('B'.$c, (string)$answer['count'])->setCellValue('C'.$c, (string)$answer['percentage'].'%')->getStyle('A'.$c)->applyFromArray($csvheader_normal_row);
							$objPHPExcelWriter->getActiveSheet()->getStyle('A'.$c.':C'.$c)->getAlignment()->setWrapText(true)->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
						}
						$c++;
					}
				}
				$c++;
				$c++;
			}
				if ( $personal ) {
					$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Total:', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, $questions['count'])->setCellValue('C'.$c, '')->setCellValue('D'.$c, $totalscore)->getStyle('A'.$c.':E'.$c)->applyFromArray($csvheader_row)->getAlignment()->setWrapText(true)->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
				}
				else {
					$objPHPExcelWriter->setActiveSheetIndex(0)->setCellValue('A'.$c, esc_html__( 'Total:', MODAL_SURVEY_TEXT_DOMAIN ))->setCellValue('B'.$c, $questions['count'])->setCellValue('C'.$c, '')->getStyle('A'.$c.':C'.$c)->applyFromArray($csvheader_row)->getAlignment()->setWrapText(true)->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
				}
				$objPHPExcelWriter->getActiveSheet()->getColumnDimension('A')->setAutoSize(true);
				$objPHPExcelWriter->getActiveSheet()->getColumnDimension('B')->setAutoSize(true);
				$objPHPExcelWriter->getActiveSheet()->getColumnDimension('C')->setAutoSize(true);
				$objPHPExcelWriter->getActiveSheet()->getColumnDimension('D')->setAutoSize(true);

$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcelWriter, 'Excel5');
$objWriter->save($path);
if (!empty($objWriter)) $result = "success";
else $result = esc_html__( 'Write error', MODAL_SURVEY_TEXT_DOMAIN );
 ?>